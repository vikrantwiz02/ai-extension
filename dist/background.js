const d={backendUrl:"http://localhost:3002/analyze",jpegQuality:95,provider:"gemini"};chrome.runtime.onMessage.addListener((t,r,e)=>{var s;if(t.type==="CAPTURE_SCREENSHOT"){if(!((s=r.tab)!=null&&s.id)){e({type:"SCREENSHOT_RESULT",success:!1,error:"Invalid tab context"});return}return h(r.tab.id).then(o=>{try{e(o)}catch(a){console.error("Failed to send response (context may be invalidated):",a)}}).catch(o=>{console.error("Error handling screenshot:",o);try{e({type:"SCREENSHOT_RESULT",success:!1,error:o.message||"Unknown error occurred"})}catch(a){console.error("Failed to send error response:",a)}}),!0}});async function h(t){if(!t)throw new Error("No active tab found");try{const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!e||!e.id)throw new Error("No active tab found");const a={image:(await new Promise((u,c)=>{chrome.tabs.captureVisibleTab(e.windowId,{format:"png"},l=>{chrome.runtime.lastError?c(new Error(chrome.runtime.lastError.message)):l?u(l):c(new Error("Screenshot capture returned empty result"))})})).split(",")[1],format:"png",provider:d.provider},n=await fetch(d.backendUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw new Error(`Backend request failed: ${n.status} ${n.statusText}`);const i=await n.json();if(!i.answer)throw new Error("Invalid response format: missing answer field");return{type:"SCREENSHOT_RESULT",success:!0,answer:i.answer}}catch(r){throw console.error("Screenshot capture error:",r),r}}chrome.runtime.onInstalled.addListener(t=>{t.reason==="install"&&console.log("AI Extension installed - no setup required")});
